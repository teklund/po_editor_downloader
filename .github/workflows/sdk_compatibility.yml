name: SDK Compatibility Check

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  test-latest-sdks:
    name: Test on ${{ matrix.sdk }} SDK
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        sdk: ['stable', 'beta']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Setup Dart ${{ matrix.sdk }}
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ matrix.sdk }}
      
      - name: Get Dart version
        id: dart-version
        run: |
          echo "version=$(dart --version 2>&1 | head -n 1)" >> $GITHUB_OUTPUT
      
      - name: Cache Dart dependencies
        uses: actions/cache@v5
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-${{ matrix.sdk }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.sdk }}-pub-
            ${{ runner.os }}-pub-
      
      - name: Install dependencies
        run: dart pub get
      
      - name: Check formatting
        run: dart format --output=none --set-exit-if-changed .
        continue-on-error: false
      
      - name: Analyze project
        run: dart analyze --fatal-infos --fatal-warnings
        continue-on-error: false
      
      - name: Run tests
        run: dart test
        continue-on-error: false
      
      - name: Report success
        if: success()
        run: |
          echo "âœ… All checks passed on ${{ matrix.sdk }} SDK"
          echo "Dart version: ${{ steps.dart-version.outputs.version }}"

  create-issue-on-failure:
    name: Create Issue on Failure
    runs-on: ubuntu-latest
    needs: test-latest-sdks
    if: failure()
    steps:
      - name: Create issue
        uses: actions/github-script@v8
        with:
          script: |
            const title = `SDK Compatibility Issue Detected`;
            const body = `## SDK Compatibility Check Failed
            
            The scheduled SDK compatibility check has detected issues with the latest Dart SDK versions.
            
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Date:** ${new Date().toISOString().split('T')[0]}
            
            ### Action Required
            Please review the workflow logs to identify:
            - Breaking changes in the Dart SDK
            - Deprecated API usage
            - Test failures
            - Analysis warnings or errors
            
            ### Next Steps
            1. Review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Update code to be compatible with the latest SDK
            3. Consider updating the minimum SDK version in \`pubspec.yaml\` if needed
            4. Close this issue once resolved
            
            ---
            *This issue was automatically created by the SDK Compatibility workflow.*`;
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'sdk-compatibility',
              per_page: 100
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('SDK Compatibility Issue')
            );
            
            if (existingIssue) {
              // Update existing issue with a comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## New Failure Detected\n\n**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n**Date:** ${new Date().toISOString().split('T')[0]}\n\nThe SDK compatibility check is still failing. Please review the latest logs.`
              });
              console.log(`Updated existing issue #${existingIssue.number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['sdk-compatibility', 'bug']
              });
              console.log(`Created issue #${issue.data.number}`);
            }
